<!doctype html>
<html lang='en-GB'>
<head>
  <meta charset='utf-8'>
  <title>Connect Four Game</title>
</head>

<body>

  <script src="jquery-3.0.0.min.js"></script>
  <script src="ractive.js"></script>
  <script src="socketio.js"></script>

  <h1>Connect Four</h1>
  <button onclick="new_game_server()">new game</button>
  <div id='container'></div>
  <script id='template' type='text/ractive'>
    <div>
      {{#if data.game_in_progress}}
        {{#if !data.win}}
          {{data.color}}'s turn
        {{else}}
          {{data.win}} has won
        {{/if}}
      {{/if}}
    </div>
    <svg>
    {{#each data.grid : column_index}}
        <circle class="in" data-column="{{column_index}}"
         cx="{{ radius + radius*2 * column_index }}"
         cy="{{ radius }}" r="{{radius}}" 
        stroke="black" fill="grey"/>
      {{#each data.grid[column_index] : y}}
        <circle
         cx="{{ radius + radius*2 * column_index }}"
         cy="{{ radius + radius*2 * (y+1) }}" r="{{radius}}" 
        stroke="black" fill="{{.}}"/>
      {{/each}}
    {{/each}}
    </svg>
  </script>
  
  <script>
    var ractive = new Ractive({
      el: '#container',
      template: '#template',
      data: {
        radius: 10,
        game_in_progress: false,
      }
    });

    const size_x = 7, size_y = 6;
    const colors = ['blue', 'green'];
    var color;
    ractive.set('data.color', color);

    function empty_grid(){
      var grid = [];
      for(var x=0; x<size_x; x++){
        var column = [];
        for(var y=0; y<size_y; y++){
          column.push('white');
        }
        grid.push(column);
      }
      ractive.set('data.grid', grid);
    }
    
    function insert(column_index){
      //console.log('insert: '+column_index);
      var grid = ractive.get('data.grid');
      var column = grid[column_index];
      var inserted = false;
      for(var y=(size_y-1); y>=0; y--){
        if(column[y] === 'white'){
          column[y] = color;
          inserted = true;
          break;
        }
      }
      ractive.set('data.grid', grid);
      return inserted;
    }

    function valid_indices(x, y){
      return (x>=0 && x<size_x) && (y>=0 && y<size_y);
    }

    const directions =
    [
        [0,1],
        [1,0],
        [0,-1],
        [-1,0],
        [1,1],
        [-1,-1],
        [-1, 1],
        [1, -1]
      ];

    function check_pos_dir(x, y, direction){
      var grid = ractive.get('data.grid');
      var x2=x;
      var y2=y;
      var circles = [];
      for(var c=0; c<4; c++){
        x2 += direction[0];
        y2 += direction[1];
        if(!valid_indices(x2, y2)) return false;
        if(grid[x2][y2]!==color) return false;
        circles.push([x2, y2]);
      }
      for(var i=0; i<4; i++){
        var pos = circles[i];
        grid[pos[0]][pos[1]]='black';
      }
      ractive.set('data.grid', grid);
      return true;
    }

    function check_endgame(){
      for(var x=0; x<size_x; x++){
        for(var y=0; y<size_y; y++){
          for(var dir_i=0; dir_i<directions.length; dir_i++){
            var direction = directions[dir_i];
            var result = check_pos_dir(x,y, direction);
            if(result) return true;
          }
        }
      }
      return false;
    }
    
    function next_turn(){
      color = colors[(colors.indexOf(color)+1)%(colors.length)];
      ractive.set('data.color', color);
    }
    
    function setMoveHandlers(){
      $('.in').each(function(){
        $(this).off('click').click(function(){
          // is game in progress?
          var win = ractive.get('data.win');
          if(win) return;
          var column = $(this).data('column');
          // try to insert
          var inserted = insert(column);
          if(!inserted){
            // unable to insert
            alert('full');
            return;
          }else{
            // able to insert, inserted
            
            socket.emit('insert_request', { column: column });
            // endgame
            var end = check_endgame();
            if(end){
              ractive.set('data.win', color);
              alert(color+' wins');
            }
          }
          // turns
          next_turn();
        });
      }); 
    }

    function new_game(){
      empty_grid();
      ractive.set('data.win', null);
      color = colors[0];
      ractive.set('data.color', color);
    }
    function new_game_server(){
      socket.emit('new_game_server');
      socket.emit('load_page_request');
    }

    socket = io.connect('http://localhost:8080');
    
    function on_insert_propagated(data){
      console.log('on_insert_propagated');
      var inserted = insert(data.column);
      if(inserted){
        var end = check_endgame();
        if(end){
          win = color;
          ractive.set('data.win', win);
          alert(color+' wins');
        }
        else{
          next_turn();
        }
      }
    }
    socket.on('insert_propagated', on_insert_propagated);
    
    function on_load_page_response(data){
      console.log('on_load_page_response');
      
      grid = data.grid;
      win = data.win;
      color = data.color;
      
      ractive.set('data', data);
      setMoveHandlers();
      ractive.set('data.game_in_progress', true);
    }
    socket.on('load_page_response', on_load_page_response);
    
    function on_new_game_propagated(data){
      console.log('on_new_game_propagated');
      new_game();
    }
    socket.on('new_game_propagated', on_new_game_propagated);
    
    // load page
    socket.emit('load_page_request');
    
  </script>
</body>
</html>